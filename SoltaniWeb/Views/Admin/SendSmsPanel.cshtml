@using SoltaniWeb.Models


@{
    //Layout = null;
    var templateMessage = ViewBag.Templateessage as List<TemplateMessagesViewModel>;
    Layout = "~/Views/shared/_layoutbootstarp.cshtml";
}

<!DOCTYPE html>


<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
@*<link href="~/css/site2.css" rel="stylesheet" />*@
@*<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">*@
@*<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">*@
@*<link href="~/Content/plugins/awesome-bootstrap-checkbox/awesome-bootstrap-checkbox.css" rel="stylesheet" />*@
@*<link href="~/Content/me/style-rtl.alpha3.min.css" rel="stylesheet" />*@


<link href="~/Content/easy-autocomplete.min.css" rel="stylesheet" />
<link href="~/Content/qunit.css" rel="stylesheet" />
@*@Scripts.Render("~/bundles/jquery")*@
@*<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>*@
<script src="~/Scripts/jquery.easy-autocomplete.min.js"></script>
<script src="~/Scripts/qunit.js"></script>
@*<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>*@
@*<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>*@

<style>
    .easy-autocomplete-container > ul {
        width: 300px;
    }
</style>
<div class="container-fluid">
    <div id="modal" class="card" role="wizard">



        <div class="card-header bg-primary text-white" style="text-align: center;">
            اعتبار پیامک:
            <span>
                @ViewBag.RemainCredit
            </span>
        </div>
        <div class="card-body">
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <a class="nav-link active" data-toggle="tab" href="#infoPanel" role="tab">پیام</a>
                <li>

                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#placementPanel" role="tab">انتخاب مشتری</a>
                <li>

                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#reviewPanel" role="tab">پایان</a>
                <li>
            </ul>
        <div class="loader">
            <center>
                <img class="loading-image" src="~/Content/img/icon/39.gif" alt="loading..">
            </center>
        </div>
            <div class="tab-content mt-2">
                <div class="tab-pane fade show active" id="infoPanel" role="tabpanel">

                    <div class="row btn-next-tab" style="text-align: right;">

                        <button class="btn btn-info" id="infoContinue">ادامه</button>
                    </div>
                    <h4></h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white" style="text-align: center;">متن پیامک</div>
                                <div class="card-body">
                                    <div>
                                        <textarea required="" name="txtMessage" id="txtMessage" rows="16" class="form-control valid parsley-validated ng-pristine ng-invalid ng-invalid-required" ng-trim="false" placeholder="متن پیامک" parsley-minwords="3" style="font-weight: 600; color: #676767;" aria-required="true"></textarea>
                                    </div>
                                    <div class="row">
                                        <div class="col-lg-12 text-center">
                                            <div class="btn-group" style="margin-top: 5px; margin-top: 5px" sms-box="" model="data.smsBoxModel" message-box-id="txtMessage">
                                                <a style="border: 1px solid; border-style: outset;" class="btn btn-smsinfo disabled opacity-1" type="button">
                                                    <span class="badge-bg" id="numberTextMessage">70/70</span>
                                                    <i class="fa fa-text-width"></i> کاراکتر
                                                </a>
                                                <a style="border: 1px solid; border-style: outset;" class="btn btn-smsinfo disabled opacity-1" type="button">
                                                    <span class="badge-bg" id="countMessage" style="">1</span>
                                                    پیامک&nbsp;
                                                </a>
                                                <a style="border: 1px solid; border-style: outset;" class="btn btn-smsinfo disabled opacity-1" type="button">
                                                    <span class="badge-bg" id="keyword">FA</span>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white" style="text-align: center;">ابزار</div>
                                <div class="card-body">
                                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <a class="nav-link active" data-toggle="tab" href="#drafts" role="tab">پیش نویس ها</a>
                                        <li>
                                        <li class="nav-item">
                                            <a class="nav-link" data-toggle="tab" href="#addDraft" role="tab">افزودن پیش نویس</a>
                                        <li>

                                    </ul>
                                    <div class="tab-content mt-2">
                                        <div class="tab-pane fade show active" id="drafts">
                                            <div style="height: 400px; overflow-y: auto; position: initial;">
                                                <div class="active" id="tab_1_1_2">
                                                    <p>از قسمت زیر می توانید یکی از متون آماده خود را انتخاب نمایید</p>
                                                    <div>
                                                        <div id="lstTemplateMessage">
                                                            @Html.Partial("_TemplateMessage", templateMessage)
                                                            <!-- end ngRepeat: quickText in data.quickTexts -->
                                                        </div>

                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="tab-pane fade" id="addDraft">

                                            <h5>در این قسمت می توانید پیش نویس خود را اضافه نمایید.</h5>
                                            <div class="form-group" style="text-align: right;">

                                                <label for="titelMessageNew">عنوان:</label>
                                                <input type="text" class="form-control" id="titelMessageNew" placeholder="عنوان پیام را وارد کنید" name="titelMessageNew">


                                            </div>
                                            <div class="form-group" style="text-align: right;">
                                                <label for="textMessageNew">متن پیام:</label>
                                                @*<input type="text" class="form-control" id="textMessageNew" placeholder="متن پیام را واید کنید" name="textMessageNew">*@
                                                <textarea required="" name="contextMessageNew" id="contextMessageNew" rows="5" class="form-control valid parsley-validated ng-pristine ng-invalid ng-invalid-required" ng-trim="false" placeholder="متن پیامک" parsley-minwords="3" style="font-weight: 600; color: #676767;" aria-required="true"></textarea>
                                            </div>

                                            <button id="btnSave" class="btn btn-primary">ذخیره</button>



                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>



                </div>

                <div class="tab-pane fade" id="placementPanel" role="tabpanel">
                    <div class="btn-next-tab" style="text-align: right;">

                        <button class="btn btn-info" id="placementContinue">ادامه</button>

                    </div>
                    <h4></h4>
                    <div class="card">
                        <div class="card-header bg-primary text-white" style="text-align: center;">مشتری ها</div>
                        <div class="card-body">
                            <ul class="nav nav-tabs" id="selectPersonTab" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link active" data-toggle="tab" href="#addDatabase" role="tab">انتخاب از ذخیره شده ها</a>
                                <li>
                                <li class="nav-item" role="presentation">
                                    <a class="nav-link" data-toggle="tab" href="#importFile" role="tab">انتخاب از فایل</a>
                                <li>
                                <li class="nav-item" role="presentation">
                                    <a class="nav-link" data-toggle="tab" href="#handy" role="tab">دستی</a>
                                <li>


                            </ul>
                            <div class="tab-content mt-2">
                                <input type="button" id="clearFilterButton" class="btn btn-secondary" value="حذف فیلتر" />
                                <hr />
                                <div class="tab-pane fade  show active" id="addDatabase">

                                    <div class="k-rtl">

                                        @(Html.Kendo().Grid<PersonViewModel>()
                                                              .Name("grid")
                                                              .Columns(columns =>
                                                              {

                                                                  columns.Select().Width(50);
                                                                  columns.Bound(p => p.GroupName).Sortable(false)
                                                                      .Filterable(filterable =>
                                                                          filterable.UI("groupFilter")


                                                                  ).Filterable(filter =>
                                                                  {
                                                                      filter.Extra(false);
                                                                      filter.Operators(op =>
                                                                      {
                                                                          op.ForString(str =>
                                                                          {
                                                                              str.Clear().Contains("شامل").IsEqualTo("مساوی با");

                                                                          });


                                                                      });
                                                                  })
                                                                      .Width(200).Title("نام گروه");
                                                                  columns.Bound(p => p.FullNamePerson).Filterable(filter =>
                                                                  {
                                                                                              //filter.Extra(false);
                                                                                              filter.Operators(op =>
                                                                      {
                                                                          op.ForString(str =>
                                                                          {
                                                                              str.Clear().Contains("شامل").IsEqualTo("مساوی با");

                                                                          });


                                                                      });
                                                                  }).Width(200).Title("مشتری");
                                                                  columns.Bound(p => p.Cell).Width(160).Filterable(true).Title("موبایل");
                                                                  columns.Bound(p => p.CodeMeli).Width(160).Filterable(true).Title("کدملی");
                                                                  columns.Bound(p => p.Tell).Width(160).Title("تلفن");
                                                                  columns.Bound(p => p.Id).Width(160).Title("ویرایش کاربر").ClientTemplate("<a target='_blank'  class='btn btn-success' href='Edit_person/#=Id#'>ویرایش</a>");
                                                              })
                                                              .Pageable(pageable => pageable
                                                                  .Refresh(true)
                                                                  .PageSizes(new int[] { 10, 20, 50, 100 })
                                                                  .ButtonCount(10))
                                                              .Sortable()
                                                              .Events(ev => ev.Change("onChange"))
                                                              .PersistSelection()
                                                              .Scrollable()
                                                              .Resizable(resizable => resizable.Columns(true))
                                                              .Filterable()
                                                              .DataSource(dataSource => dataSource
                                                                  .Ajax()
                                                                  .PageSize(10)
                                                                  .Model(model => model.Id(p => p.Id))
                                                                  .Read(read => read.Action("Persons_Read", "Admin"))
                                                              ))
                                    </div>

                                </div>
                                <div class="tab-pane fade" id="importFile">
                                    <div class="stat-num" style="font-weight:600">درج از اکسل</div>
                                    <p>از این قسمت می توانید شماره های خود را از یک فایل اکسل درج نمایید.</p>
                                    <input type="file" name="file" id="file" value="انتخاب فایل" /><br><br>

                                </div>
                                <div class="tab-pane fade" id="handy">
                                    <div style="height: 400px; overflow-y: auto; position: initial;">
                                        <div class="active" id="tab_1_1_2">
                                            <div class="btn-next-tab" style="text-align: right;">

                                                <h5>مشتری مورد نظر را انتخاب کنید</h5>

                                            </div>
                                            <br />
                                            <div class="k-rtl demo-section k-content col-md-6">

                                                @(Html.Kendo().AutoComplete()
                                                                                              .Name("persons")
                                                                                              .DataTextField("cell")
                                                                                              .DataSource(source =>
                                                                                              {
                                                                                                  source.Read(read =>
                                                                                                  {

                                                                                                      read.Action("AutocompletePerson", "Admin").Data("additionalInfo");
                                                                                                  });
                                                                                                  source.ServerFiltering(true);
                                                                                              })

                                                                                              .HtmlAttributes(new { style = "width:100%" })
                                                                                              .Filter("startswith")
                                                                                              .MinLength(3)

                                                                                              .Height(400)
                                                                                              .HtmlAttributes(new { style = "width:100%" })
                                                                                              .Template(" #= name # | #= cell # ")
                                                )

                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>


                        </div>
                    </div>



                </div>

                <div class="tab-pane fade" id="reviewPanel" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <button onclick="" class="btn btn-success" id="activate">تایید و ارسال پیام</button>

                        </div>
                    </div>
                    <h4></h4>

                    <div class="card">
                        <div class="card-header" style="text-align: center;">متن پیامک</div>
                        <div class="card-body" style="text-align: right;" id="reviewContextMessage">

                        </div>
                    </div>

                    <h4></h4>

                    <div class="card">
                        <div class="card-header" style="text-align: center;">مشتری ها</div>
                        <div class="card-body">
                            <div class="row" id="PersonCellPhoneAdd">
                                <label id="lblPersonCellPhone">شماره مشتری : </label>
                                <label id="lblPersonCellPhoneTe"> </label>
                            </div>
                            <div class="row" id="PersonFileAdd">
                                <label id="lblPersonFile">نام فایل : </label>
                                <label id="lblPersonFileTe"> </label>
                            </div>
                            <div class="row" id="partialPersonSelected"></div>
                        </div>
                    </div>



                </div>
            </div>
            @*<div class="progress mt-5">
                    <div class="progress-bar" role="progressbar" style="width: 20%" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100">Step 1 of 5</div>
                </div>*@
        </div>



    </div>
</div>
@*@Scripts.Render("~/bundles/jquery")*@


<script>
    $('.loader').hide();
    $('#searchMessage').keyup(function () {
        var testData = this.value;
        $('#divMessageTemps:contains("' + testData + '")').css('background-color', 'red');
        $('#divMessageTemps:contains("' + testData + '")').focus();
    });
    function groupFilter(element) {
        element.kendoDropDownList({
            dataSource: {
                transport: {
                    read: "@Url.Action("FilterMenuCustomization_Groups")"
                }
            },
            optionLabel: "--انتخاب گروه--"
        });
    }
    $("#clearFilterButton").click(function (){

        $("#grid").data("kendoGrid").dataSource.filter({});
    });
    var checkedValuesTemp = [];
    var tempPersonIdHandy=0;

    function additionalInfo() {
        return {
            data: $("#persons").val()
        }
    }
    function onChange(arg) {
        //kendoConsole.log("The selected product ids are: [" + this.selectedKeyNames().join(", ") + "]");
        //  alert(this.selectedKeyNames());
        checkedValuesTemp=this.selectedKeyNames();
        //  alert(checkedValuesTemp);

    }

    function deletePersonSelected(e) {
        e.preventDefault();

        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
        var sf = $.inArray(dataItem.id, checkedValuesTemp);
        checkedValuesTemp = jQuery.grep(checkedValuesTemp, function(value) {
            return value != dataItem.id;
        });


    }
    $('#infoContinue').click(function (e) {

        e.preventDefault();
        //if ($('#txtMessage').val() === "") {
        //    alert("متن پیام را وارد کنید");
        //    return false;
        //}

        $('#myTab a[href="#placementPanel"]').tab('show');
    });



    $('#placementContinue').click(function (e) {
        e.preventDefault();
        var files = $("#file").get(0).files;
        tempPersonIdHandy = $("#persons").val();

        if (checkedValuesTemp.length == 0 && (tempPersonIdHandy == 0 || tempPersonIdHandy == "") && files==="") {
            alert("حداقل انتخاب مشتری یک می باشد");
            return false;
        }

        var context = $('#txtMessage').val();
        if (context === "" && files.length===0) {

            alert(" متن پیام را وارد کنید");
            return false;
        }
        if (files.length !== 0) {
            $('#lblPersonFileTe').text(files[0].name); 
            $('#PersonFileAdd').show();
        } else {
            $('#PersonFileAdd').hide();
        }
          
      
        if ((tempPersonIdHandy !== 0 && tempPersonIdHandy !== "")) {
            $('#lblPersonCellPhoneTe').text(tempPersonIdHandy);
            $('#PersonCellPhoneAdd').show();
        } else {
            $('#PersonCellPhoneAdd').hide();
        }
        $.post('@Url.Action("PersonsSelected", "Admin")',
            { personId: checkedValuesTemp},
            function(data) {
                $("#partialPersonSelected").html(data);
            }).fail(function() {

            alert('خطا در بروز عملیات');
        });
        $('#reviewContextMessage').html(context);



        $('#myTab a[href="#reviewPanel"]').tab('show');
    });
    $("#btnSave").click( function() {

        var title=  $('#titelMessageNew').val();
        var context = $('#contextMessageNew').val();
        if (title == "" || context == "") {

            alert("عنوان و متن پیام را وارد کنید");
            return false;
        }
        $.post('@Url.Action("CreateTemplateMessage")',
            { title: title, context: context},
            function(data) {



                if (data.IsSuccessed) {

                    $("#lstTemplateMessage").load('@Url.Action("TemplateMessage", "Admin")');
                }
                alert(data.Message);
                $('#titelMessageNew').val("");
                $('#contextMessageNew').val("");
            }).fail(function() {

            alert('خطا  در بروز عملیات');
        });
    });


    function deletTempMessage(id) {

        if (id === "" ) {

            alert("خطا در عملیات");
            return false;
        }
        $.post('@Url.Action("DeletTemplateMessage")',
            { id: id},
            function(data) {


                if (data.IsSuccessed) {

                    $("#lstTemplateMessage").load('@Url.Action("TemplateMessage", "Admin")');
                }
                alert(data.Message);

            }).fail(function() {

            alert('خطا  در بروز عملیات');
        });
    };




    function quickTextSelected(text) {
        $('#txtMessage').val(text);
        $('#txtMessage').keyup();
    };

    $(function() {

        $('#activate').click(function(e) {
            e.preventDefault();
            var files = $("#file").get(0).files;
            if (checkedValuesTemp.length == 0 && (tempPersonIdHandy === 0 || tempPersonIdHandy === "") && files.length === 0 ) {
                alert("حداقل انتخاب مشتری یک می باشد");
                return false;
            }

            var context = $('#txtMessage').val();
            if (context === "" && files.length===0) {

                alert(" متن پیام را وارد کنید");
                return false;
            }
            var file1 = $("#file")[0].files[0];
            var formData = new FormData();

            $('.loader').show();

            formData.append("fileNumber", files[0]);
            formData.append("personCellphone", tempPersonIdHandy);
            formData.append("context", context);
            formData.append("personsId", checkedValuesTemp);
            $.ajax({
                url: '@Url.Action("SendMessage")',
                type: 'POST',
                cache: false,
                processData: false,
                contentType: false,
                data: formData,
                success: function (data) {
                    $('.loader').hide();
                    alert(data.Message);
                    $('#titelMessageNew').val("");
                    $('#lblPersonCellPhoneTe').text("");
                    $('#PersonCellPhoneAdd').hide();
                    $('#contextMessageNew').val("");
                    $('#lblPersonFileTe').text(""); 
                    $('#PersonFileAdd').hide();
                    $("#file").val('');
                    $("#file").get(0).files.length = 0;
                    $("#persons").val(' ');
                    tempPersonIdHandy = '';
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $('.loader').hide();
                    alert('خطا  در بروز عملیات');
                }
            });
            @*$.post('@Url.Action("SendMessage")',
                processData: false,
                ,
                function (data) {
                    alert(data.Message);
                    $('#titelMessageNew').val("");
                    $('#contextMessageNew').val("");
                }).fail(function () {

                    alert('خطا  در بروز عملیات');
                });*@
        });
    });



    function OpenWindowSendMessageGroup() {
        $('.chSelect-Person:checked').map(function () {

            var item = $(this).attr('data-id');
            if (jQuery.inArray(item, checkedValuesTemp) === -1) {
                checkedValuesTemp.push(item);
            }
        }).get();


    }

    $(document).ready(function () {
        $("#col-checkbox-all").click(function () {
            $(".checkbox").prop("checked", $(this).prop("checked"));
        });


        var isPersianKey = true;

        $('#txtMessage').keyup(function () {
            var lengthCount = this.value.length;
            var sdf = this.value.substring(0, 1);

            if (just_persian(this.value.substring(0, 1))) {
                $('#keyword').text('FA');
                isPersianKey = true;
            } else {
                isPersianKey = false;
                $('#keyword').text('EN');
            }
            // }
            if (isPersianKey) {
                if (lengthCount <= 70) {
                    $('#numberTextMessage').text(70 - lengthCount + "/70");
                    $('#countMessage').text(1);
                }
                else if (lengthCount <= 134) {

                    $('#numberTextMessage').text(64 - (lengthCount - 70) + "/64");
                    $('#countMessage').text(2);

                }
                else {

                    $('#numberTextMessage').text(67 - (lengthCount % 67) + "/67");
                    $('#countMessage').text(Math.ceil(lengthCount / 67));
                }
            }
            else {
                if (lengthCount <= 160) {
                    $('#numberTextMessage').text(160 - lengthCount + "/160");
                    $('#countMessage').text(1);
                } else if (lengthCount <= 306) {

                    $('#numberTextMessage').text(146 - (lengthCount - 160) + "/146");
                    $('#countMessage').text(2);

                } else {

                    $('#numberTextMessage').text(153 - (lengthCount % 153) + "/153");
                    $('#countMessage').text(Math.ceil(lengthCount / 153));
                }
            }



        });
        function just_persian(str) {
            var p = /^[\u0600-\u06FF\s]+$/;
            if (!p.test(str)) {
                return false;
            }
            return true;
        }


        $("#col-checkbox-all").click(function () {
            $(".checkbox").prop("checked", $(this).prop("checked"));

            OpenWindowSendMessageGroup();
        });
        $(".chSelect-Person").click(function () {
            var item = $(this).attr('data-id');
            if (jQuery.inArray(item, checkedValuesTemp) === -1) {
                checkedValuesTemp.push(item);
            }
            // alert(checkedValuesTemp);
        });
        $("#grid .k-grid-content").on("change",
            'input.checkbox[name="percheckbox"]',
            function (e) {
                var item = $(this).attr('data-id');
                if ($(this).prop("checked")) {
                    checkedValuesTemp.push(item);
                } else {
                    // checkedValuesTemp.splice($.inArray(item, checkedValuesTemp), 1);
                    checkedValuesTemp = jQuery.grep(checkedValuesTemp, function(value) {
                        return value != item;
                    });
                }
                // alert(checkedValuesTemp);
            });


    });
</script>
