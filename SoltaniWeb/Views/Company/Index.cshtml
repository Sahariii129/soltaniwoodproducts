@using SoltaniWeb.Models.structs.CompanyVM
@using SoltaniWeb.Models.structs.PersonVM
@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/shared/_layoutbootstarp.cshtml";
}



<div class="container-fluid">
    <div id="modal" class="card" role="wizard">
        <div class="card-header bg-primary text-white" style="text-align: center;"> شرکت</div>
        <div class="card-body">
            <input type="hidden" id="companyId" value="@ViewBag.CompanyId" />
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <a class="nav-link active" data-toggle="tab" href="#lstCompany" role="tab">لیست شرکت ها</a>
                <li>
                <li class="nav-item" >
                <a class="nav-link" data-toggle="tab" href="#lstCompanyPerson" role="tab">لیست مشتری های شرکت</a>
                <li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#addPerson" role="tab">اضافه کردن مشتری به شرکت</a>
                <li>

                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#addCompany" role="tab">اضافه کردن گروه شرکت</a>
                <li>
            </ul>
            <div class="tab-content mt-2">
                <div class="tab-pane fade show active" id="lstCompany" role="tabpanel">
                    <div class="tab-pane fade show active" id="divlstCompany" role="tabpanel">
                        @Html.Partial("_CompanyList")
                    </div>

                </div>
                <div class="tab-pane fade" id="lstCompanyPerson" role="tabpanel">
                    <div id="divCompanyPerson" >
                        @Html.Partial("_CompanyPerson")
                    </div>

                </div>
                <div class="tab-pane fade" id="addPerson" role="tabpanel">
                    <div class="row btn-next-tab" style="text-align: right;">

                        <button class="btn btn-info" id="btnaddPersonToCompany">اضافه کردن به شرکت</button>
                    </div>
                    <h4></h4>
                    <div class="row col-md-12" id="lstCompanyDrop">

                        @Html.Partial("_ListCompanyForDrop")
                    </div>
                    <h4></h4>
                    <div class="tab-pane fade show active" id="lstPersonInGroup" role="tabpanel">
                        @Html.Partial("_Person")
                    </div>
                </div>
                <div class="tab-pane fade" id="addCompany" role="tabpanel">
                    @Html.Partial("_Create", new CompanyViewModel())
                </div>
            </div>
        </div>
    </div>
</div>
<script>

    $("#clearFilterButton").click(function () {

        $("#grid_company").data("kendoGrid").dataSource.filter({});
    });

</script>
<script>

    var selectedDropDownValue = 0;
    var checkedValuesTemp = [];
    var checkedValuesTempNotMap = [];
    function AddFilter()
    {
        return { companyId: selectedDropDownValue};
    }
    function searchGrid()
    {
        var gridListFilter = { filters: [] };
        var gridDataSource = $("#gridPerson").data("kendoGrid").dataSource;
        gridDataSource.read();
    }


    function onChange(arg) {

            checkedValuesTemp = this.selectedKeyNames();
    }
    function change() {
        var dropdownListCompany = $("#dropdownListCompany").data("kendoDropDownList");
        selectedDropDownValue = dropdownListCompany.value();
        searchGrid();
    };
    function delPersonGroup(companyId,personId) {
        $.post('@Url.Action("PersonCompanyDestroy")',
            { companyId: companyId, personId: personId},
            function(data) {
                if (data.IsSuccessed) {
                    $("#divCompanyPerson").load('@Url.Action("CompanyPerson", "Company")');
                }
                alert(data.Message);
                checkedValuesTemp = [];
            }).fail(function() {

            alert('خطا  در بروز عملیات');
        });
    }
    $("#btnaddPersonToCompany").click( function() {

        if (checkedValuesTemp.length === 0 || (selectedDropDownValue === 0 || selectedDropDownValue === "")) {
            alert("انتخاب گروه و مشتری های اجباری می باشد");
            return false;
        }
        $.post('@Url.Action("AddPersonToCompany")',
            { companyId: selectedDropDownValue , personId: checkedValuesTemp},
            function(data) {
                if (data.IsSuccessed) {
                    $("#lstPersonInGroup").load('@Url.Action("Person", "Company")');
                    $("#divCompanyPerson").load('@Url.Action("CompanyPerson", "Company")');
                }
                alert(data.Message);
                checkedValuesTemp = null;
            }).fail(function() {

            alert('خطا  در بروز عملیات');
        });
    });
   
</script>