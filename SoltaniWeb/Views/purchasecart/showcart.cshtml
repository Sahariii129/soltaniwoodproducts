@using SoltaniWeb.Models.Domain
@using SoltaniWeb.Models.repository
@inject IUserServices _user;
@model IEnumerable<tbl_purchasekartitemlist>
@{
    ViewBag.Title = "showcart";
    Layout = "~/Views/shared/_layoutbootstarp.cshtml";
    int i = 0;
    SoltaniWeb.Models.repository.entityproducutsreposit entityrep = new SoltaniWeb.Models.repository.entityproducutsreposit();
    var cartid = 0;

    cartid = Model.FirstOrDefault().perchasekart_id;

    TempData["cartid"] = cartid;
    var transportationrecord = Model.FirstOrDefault().perchasekart_.tbl_transportationcost.FirstOrDefault();
    _4820_soltaniwebContext db = new _4820_soltaniwebContext();
    var vehicletypes = db.tbl_vehicletype.ToList();
    var translocationinfo = db.tbl_transportaiondetails.Where(a => a.cartid == cartid);
    var qtranscost = db.tbl_transportationcost.Where(a => a.cart_id == cartid);
    var userid = _user.GetUseridByUsername(User.Identity.Name);
    var status = Model.FirstOrDefault().perchasekart_.status.Value;
    string resultclass = "width" + status;

}

<link href="~/soltanistatic/style/flipclock.css" rel="stylesheet" />
<link href="~/soltanistatic/style/cart.css" rel="stylesheet" />
<div class="container-fluid" data-aos="fade-up">
    <div class="row my-4">
        <div class="col-12">
            <div style="position:relative">
                <h5 class="my-5 contactTitle">سبد خرید شما</h5>
            </div>
        </div>
        <div class="col-12 myfont">
            @if (Model.Count()>0)
            {
            <div class="card">
                <div class="card-header text-center py-0" style=" background-color: #332b3a;color:#fff">
                    <div class="container">
                        <ul class="nav nav-tabs mt-2 pb-3 pr-0 justify-content-between @(resultclass)" id="myTab" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link @(status>=0?"active":"disabled")" purchasestatus=0 data-toggle="tab" href="#step1" role="tab" aria-selected="true">انتخاب کالا</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link @(status>=1?"active":"disabled")" purchasestatus=1 data-toggle="tab" href="#step2" role="tab" aria-selected="false">درخواست قیمت</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link @(status>=2?"active":"disabled")" purchasestatus=2 data-toggle="tab" href="#step3" role="tab" aria-selected="false">دریافت قیمت</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link @(status>=3?"active":"disabled")" purchasestatus=3 data-toggle="tab" href="#step4" role="tab" aria-selected="false">تایید سبد خرید</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link @(status>=4?"active":"disabled")" purchasestatus=4 data-toggle="tab" href="#step5" role="tab" aria-selected="false">پرداخت و تحویل</a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="card-body text-center">
                    <p class="blue bold mb-4 mt-3">افزودن کالاها به سبد خرید به معنی رزرو کالا برای شما نیست. برای ثبت سفارش باید مراحل بعدی خرید را تکمیل نمایید.</p>
                    <div class="tab-content">
                        <div class="tab-pane @(status==0?"active":"")" purchasestatus=0 id="step1" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-bordered sortable purchasecart" id="@cartid" cartid="@cartid" userid="@userid">
                                    <thead>
                                        <tr>
                                            <td>ردیف </td>
                                            <td>تصویر </td>
                                            <td> شرح محصول </td>
                                            <td> تعداد </td>
                                            <td>قیمت واحد</td>
                                            <td>قیمت کل</td>
                                            <td>حذف محصول</td>
                                        </tr>
                                    </thead>
                                    <tbody>

                                        @foreach (var item in Model)
                                        {
                                            i++;
                                            <tr id="@("item" + @item.id)">
                                                <td>@i</td>
                                                <td><img class="imgProduct img-fluid" src="@(item.product_.thumbnail_image==null ? "~/Content/img/icon/img-na.png" : (string.Format("data:image/jpeg;base64,{0}", Convert.ToBase64String(item.product_.thumbnail_image))))" alt="تصویر محصول" /></td>
                                                <td>
                                                    <div> @(item.product_.category.categoryname + " " + item.product_.name + " " + item.product_.codename)</div>
                                                    @*<div style="float:left; font-size:12px; color:#b200ff; ">وزن واحد: @string.Format("{0:#,##0.##}", item.product_.weight) Kg </div>*@
                                                </td>
                                                <td>
                                                    <input class="form-control itemnumber" type="number" id="@item.id" value="@item.number" min="0" max="@entityrep.getentityitem(item.product_id)" />
                                                </td>
                                                <td>
                                                    <div style="color:#eaa01b ; "><span class="unitprice">منتظر باشید ... </span> </div>
                                                </td>
                                                <td id="@("totalpriceitem" + item.id)">0.0 ریال </td>
                                                <td><a href="#" class="deleteitem" id="@item.id"><img src="~/Content/img/icon/delete.png" class="img-responsive" alt="Alternate Text" /></a></td>
                                            </tr>
                                        }

                                        <tr style="background-color: rgb(248, 238, 201);color:red">
                                            <td>جمع کل</td>
                                            <td></td>
                                            <td></td>
                                            <td><span id="totalnumber" class="form-control totalnumber" style="width:50%;margin:auto;color:red">@Model.Sum(a => a.number)</span></td>
                                            <td></td>
                                            <td>0.0 ریال </td>
                                            <td></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <button id="saveandsentorder" class="btn mt-5">ثبت و ارسال گزارش</button>
                        </div>
                        <div class="tab-pane @(status==1?"active":"")" purchasestatus=1 id="step2" role="tabpanel">
                            <div class="pt-5 d-flex justify-content-between align-items-center">
                                <div class="blue"><h5>لطفا جهت دریافت قیمت از سوی کارشناسان ما منتظر بمانید...</h5></div>
                                <div class=""><div class="your-clock"></div></div>
                            </div>
                        </div>
                        <div class="tab-pane @(status==2?"active":"")" purchasestatus=2 id="step3" role="tabpanel">

                            <partial name="~/Views/Shared/PartialCarts/_partialcartforclient.cshtml" model="@Model.FirstOrDefault().perchasekart_" />

                        </div>
                        <div class="tab-pane @(status==3?"active":"")" purchasestatus=3 id="step4" role="tabpanel">تایید سبد خرید</div>
                        <div class="tab-pane @(status==4?"active":"")" purchasestatus=4 id="step5" role="tabpanel">پرداخت و تحویل</div>
                    </div>
                </div>
            </div>
            }
            else
            {
                <div class="alert alert-danger">
                    <center>
                        سبد خرید شما خالی است!
                    </center>
                </div>
            }
            </div>
    </div>
</div>

        <script src="~/lib/signalr/dist/browser/signalr.js"></script>
        <script src="~/soltanistatic/script/flipclock.min.js"></script>
        <script>
            var clock = $('.your-clock').FlipClock({
                // ... your options here
            });

            var userid = $('.purchasecart').attr('userid')
            var cartid = $('.purchasecart').attr('cartid')
            var connectionid = ""
            var connection = new signalR.HubConnectionBuilder().withUrl("/chatHub").build();
            connection.start().catch(err => console.error(err.toString())).then(function () {
                connection.invoke('getConnectionId')
                    .then(function (connectionId) {
                        // Send the connectionId to controller
                        connectionid = connectionId;
                        connection.invoke("registerindb", userid, cartid, connectionid)
                    })
            })

            $(saveandsentorder).click(function () {
                $('#myTab').toggleClass('width1')
                connection.invoke("sendpricebyclient", userid, cartid, connectionid)
                $(this).attr("disabled", true);
            })

            connection.on("setDemandPriceStepInClient", function (pstatus) {
                for (var i = 0; i <= pstatus; i++) {
                    $('.nav-link[purchasestatus="' + i + '"]').addClass('active')
                }
                $('.tab-pane').removeClass('active')
                $('.tab-pane[purchasestatus="' + pstatus + '"]').addClass('active')
            })

            connection.on("getPricefromServer", function (cartid, pstatus) {  
                $('#myTab').toggleClass('width2')
                jQuery.post('/admin/getpurchasecart', { cartid: cartid }, function (result) {
                    $('.tab-pane[purchasestatus="2"]').html(result)
                    for (var i = 0; i <= 2; i++) {

                        $('.nav-link[purchasestatus="' + i + '"]').addClass('active')
                    }
                    $('.tab-pane').removeClass('active')
                    $('.tab-pane[purchasestatus="' + 2 + '"]').addClass('active')
                })
            })

            $('body').on('click', '#getPriceBtn', function (e) {
                var cartid = $(this).attr('cartid')
                $('#myTab').toggleClass('width2')
                jQuery.post('/admin/getpurchasecart', { cartid: cartid }, function (result) {
                    $('.tab-pane[purchasestatus="2"]').html(result)
                    for (var i = 0; i <= 2; i++) {

                        $('.nav-link[purchasestatus="' + i + '"]').addClass('active')
                    }
                    $('.tab-pane').removeClass('active')
                    $('.tab-pane[purchasestatus="' + 2 + '"]').addClass('active')
                })
            })

            // to click in tab
            $('.nav-link').click(function (e) {
                return;
            })

            $('.itemnumber').change(function () {
                var id = $(this).attr('id')
                var itemnumber = $(this).val()
                jQuery.post('/purchasecart/editnumber', { id: id, itemnumber: itemnumber }, function (result) {

                    if (result.status == 'false') {
                        var html = 'سفارش شما بیش از موجودی انبار وب سایت می باشد.'
                        html += '<br/>'
                        html += '<br/>'
                        html += 'نام کالا: ' + result.productname
                        html += '<br/>'
                        html += '<br/>'
                        html += 'موجودی : ' + result.maxcount
                        html += '<br/>'
                        html += '<br/>'
                        html += 'چنانچه واقعا بیش از این مقدار قصد خرید دارید با دفتر فروشگاه تماس حاصل فرمایید'
                        html += '<br/>'
                        html += '<br/>'
                        html += 'تلفن فروشگاه : 07138219110    ----   تلفن انبار : 07137742067'
                        $(messagenotokheader).html('سفارش بیش از موجودی ')
                        $(messagenotokbody).html(html)
                        $(messagenotok).modal()
                    } else {
                        $("#price" + id).html(result.newprice)
                        $('#totalnumber').html(result.totalnumber)
                    }
                })
            })
           
            $('body').on('click', '.deleteitem', function (e) {
                e.preventDefault()
                if (confirm('آیا اطمینان به حذف این محصول دارید')) {
                    var id = $(this).attr('id')
                    var itemtodelete = $(this).parents('tr')
                   
                    jQuery.post('/purchasecart/deleteitem', { id: id }, function (result) {
                        alert(JSON.stringify(result))
                        itemtodelete.remove()
                        $(".totalprice").html(result.totalprice)
                        $(".discount").html(result.discount)
                        $(".payableprice").html(result.payableprice)
                        $('.totalnumber').html(result.totalnumber)
                                          
                    })
                }
            })
        </script>
